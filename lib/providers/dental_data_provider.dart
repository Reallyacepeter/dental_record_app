// import 'package:flutter/material.dart';
//
// class DentalDataProvider extends ChangeNotifier {
//   // üìå FDI ÏπòÏïÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞
//   final Map<int, Map<String, dynamic>> fdiToothData = {};
//
//   // üìå 640: Í∏∞ÌÉÄ ÏÜåÍ≤¨
//   String otherFindings = "";
//
//   // üìå 645: ÏπòÏó¥ Ïú†Ìòï
//   String dentitionType = "";
//
//   // üìå 647: ÎÇòÏù¥ Ï∂îÏ†ï
//   int? ageMin;
//   int? ageMax;
//
//   // üìå 650: ÌíàÏßà ÌôïÏù∏
//   String qualityCheckSignature = "";
//   DateTime? qualityCheckDate;
//
//   // üìå 610: Materials Available
//   bool upperJawWithTeeth = false;
//   bool lowerJawWithTeeth = false;
//   bool upperJawWithoutTeeth = false;
//   bool lowerJawWithoutTeeth = false;
//   bool fragments = false;
//   String teethOnly = '';
//   String otherMaterials = '';
//
//   bool paDigital = false;
//   bool paNonDigital = false;
//   bool bwDigital = false;
//   bool bwNonDigital = false;
//   bool opgDigital = false;
//   bool opgNonDigital = false;
//   bool ctDigital = false;
//   bool ctNonDigital = false;
//   bool otherDigital = false;
//   bool otherNonDigital = false;
//   bool photographsDigital = false;
//   bool photographsNonDigital = false;
//   String otherRadiographs = '';
//   List<String> uploadedFiles = [];
//
//   String conditionOfJaws = '';
//   String otherDetails = '';
//
//   // üìå RecordScreen Í¥ÄÎ†® ÌïÑÎìú
//   String placeOfDisaster = '';
//   String natureOfDisaster = '';
//   String pmNumber = '';
//   DateTime? dateOfDisaster;
//   String gender = '';
//
//   // ===============================
//   //           SETTERS
//   // ===============================
//
//   void setToothDetail(int tooth, String detail) {
//     fdiToothData[tooth] = {"detail": detail};
//     notifyListeners();
//   }
//
//   void setOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void setDentitionType(String value) {
//     dentitionType = value;
//     notifyListeners();
//   }
//
//   void setAgeRange(int? min, int? max) {
//     ageMin = min;
//     ageMax = max;
//     notifyListeners();
//   }
//
//   void setQualityCheck(String signature, DateTime? date) {
//     qualityCheckSignature = signature;
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setMaterialsAvailable({
//     required bool upperWith,
//     required bool lowerWith,
//     required bool upperWithout,
//     required bool lowerWithout,
//     required bool hasFragments,
//     required String teethText,
//     required String otherText,
//   }) {
//     upperJawWithTeeth = upperWith;
//     lowerJawWithTeeth = lowerWith;
//     upperJawWithoutTeeth = upperWithout;
//     lowerJawWithoutTeeth = lowerWithout;
//     fragments = hasFragments;
//     teethOnly = teethText;
//     otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setEachMaterial({
//     bool? upperWith,
//     bool? lowerWith,
//     bool? upperWithout,
//     bool? lowerWithout,
//     bool? hasFragments,
//     String? teethText,
//     String? otherText,
//   }) {
//     if (upperWith != null) upperJawWithTeeth = upperWith;
//     if (lowerWith != null) lowerJawWithTeeth = lowerWith;
//     if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
//     if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
//     if (hasFragments != null) fragments = hasFragments;
//     if (teethText != null) teethOnly = teethText;
//     if (otherText != null) otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setDentalImages({
//     bool? paD, bool? paND,
//     bool? bwD, bool? bwND,
//     bool? opgD, bool? opgND,
//     bool? ctD, bool? ctND,
//     bool? otherD, bool? otherND,
//     bool? photoD, bool? photoND,
//     String? otherRadio,
//     List<String>? uploads,
//   }) {
//     if (paD != null) paDigital = paD;
//     if (paND != null) paNonDigital = paND;
//     if (bwD != null) bwDigital = bwD;
//     if (bwND != null) bwNonDigital = bwND;
//     if (opgD != null) opgDigital = opgD;
//     if (opgND != null) opgNonDigital = opgND;
//     if (ctD != null) ctDigital = ctD;
//     if (ctND != null) ctNonDigital = ctND;
//     if (otherD != null) otherDigital = otherD;
//     if (otherND != null) otherNonDigital = otherND;
//     if (photoD != null) photographsDigital = photoD;
//     if (photoND != null) photographsNonDigital = photoND;
//     if (otherRadio != null) otherRadiographs = otherRadio;
//     if (uploads != null) uploadedFiles = uploads;
//     notifyListeners();
//   }
//
//   void setConditionOfJaws(String value) {
//     conditionOfJaws = value;
//     notifyListeners();
//   }
//
//   void setOtherDetails(String value) {
//     otherDetails = value;
//     notifyListeners();
//   }
//
//   void updateToothDetail(int toothNumber, String detail) {
//     fdiToothData[toothNumber] = {'detail': detail};
//     notifyListeners();
//   }
//
//   void updateOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void updateDentitionType(String type) {
//     dentitionType = type;
//     notifyListeners();
//   }
//
//   void updateAgeMin(int? value) {
//     ageMin = value;
//     notifyListeners();
//   }
//
//   void updateAgeMax(int? value) {
//     ageMax = value;
//     notifyListeners();
//   }
//
//   void updateQualitySignature(String value) {
//     qualityCheckSignature = value;
//     notifyListeners();
//   }
//
//   void updateQualityDate(DateTime date) {
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   // üìå RecordScreen Í¥ÄÎ†® setterÎì§
//   void updatePlace(String place) {
//     placeOfDisaster = place;
//     notifyListeners();
//   }
//
//   void updateNature(String nature) {
//     natureOfDisaster = nature;
//     notifyListeners();
//   }
//
//   void updatePmNumber(String pm) {
//     pmNumber = pm;
//     notifyListeners();
//   }
//
//   void updateDisasterDate(DateTime date) {
//     dateOfDisaster = date;
//     notifyListeners();
//   }
//
//   void updateGender(String selectedGender) {
//     gender = selectedGender;
//     notifyListeners();
//   }
//
//   // ===============================
//   //         FIREBASE Ï†ÄÏû•Ïö©
//   // ===============================
//
//   Map<String, dynamic> toMap() {
//     return {
//       'placeOfDisaster': placeOfDisaster,
//       'natureOfDisaster': natureOfDisaster,
//       'pmNumber': pmNumber,
//       'dateOfDisaster': dateOfDisaster?.toIso8601String(),
//       'gender': gender,
//
//       'fdiToothData': fdiToothData.map((k, v) => MapEntry(k.toString(), v)),
//       'otherFindings': otherFindings,
//       'dentitionType': dentitionType,
//       'ageMin': ageMin,
//       'ageMax': ageMax,
//       'qualityCheckSignature': qualityCheckSignature,
//       'qualityCheckDate': qualityCheckDate?.toIso8601String(),
//
//       // Materials Available
//       'upperJawWithTeeth': upperJawWithTeeth,
//       'lowerJawWithTeeth': lowerJawWithTeeth,
//       'upperJawWithoutTeeth': upperJawWithoutTeeth,
//       'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
//       'fragments': fragments,
//       'teethOnly': teethOnly,
//       'otherMaterials': otherMaterials,
//
//       // Dental Images
//       'paDigital': paDigital,
//       'paNonDigital': paNonDigital,
//       'bwDigital': bwDigital,
//       'bwNonDigital': bwNonDigital,
//       'opgDigital': opgDigital,
//       'opgNonDigital': opgNonDigital,
//       'ctDigital': ctDigital,
//       'ctNonDigital': ctNonDigital,
//       'otherDigital': otherDigital,
//       'otherNonDigital': otherNonDigital,
//       'photographsDigital': photographsDigital,
//       'photographsNonDigital': photographsNonDigital,
//       'otherRadiographs': otherRadiographs,
//       'uploadedFiles': uploadedFiles,
//
//       // Jaws and Additional Notes
//       'conditionOfJaws': conditionOfJaws,
//       'otherDetails': otherDetails,
//     };
//   }
// }

// import 'package:flutter/material.dart';
//
// class DentalDataProvider extends ChangeNotifier {
//   // üìå FDI ÏπòÏïÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞
//   final Map<int, Map<String, dynamic>> fdiToothData = {};
//
//   // üìå 640: Í∏∞ÌÉÄ ÏÜåÍ≤¨
//   String otherFindings = "";
//
//   // üìå 645: ÏπòÏó¥ Ïú†Ìòï
//   String dentitionType = "";
//
//   // üìå 647: ÎÇòÏù¥ Ï∂îÏ†ï
//   int? ageMin;
//   int? ageMax;
//
//   // üìå 650: ÌíàÏßà ÌôïÏù∏
//   String qualityCheckSignature = "";
//   DateTime? qualityCheckDate;
//
//   // üìå 610: Materials Available
//   bool upperJawWithTeeth = false;
//   bool lowerJawWithTeeth = false;
//   bool upperJawWithoutTeeth = false;
//   bool lowerJawWithoutTeeth = false;
//   bool fragments = false;
//   String teethOnly = '';
//   String otherMaterials = '';
//
//   bool paDigital = false;
//   bool paNonDigital = false;
//   bool bwDigital = false;
//   bool bwNonDigital = false;
//   bool opgDigital = false;
//   bool opgNonDigital = false;
//   bool ctDigital = false;
//   bool ctNonDigital = false;
//   bool otherDigital = false;
//   bool otherNonDigital = false;
//   bool photographsDigital = false;
//   bool photographsNonDigital = false;
//   String otherRadiographs = '';
//   List<String> uploadedFiles = [];
//
//   String conditionOfJaws = '';
//   String otherDetails = '';
//
//   // üìå RecordScreen Í¥ÄÎ†® ÌïÑÎìú
//   String placeOfDisaster = '';
//   String natureOfDisaster = '';
//   String pmNumber = '';
//   DateTime? dateOfDisaster;
//   String gender = '';
//
//   // ===============================
//   //           SETTERS
//   // ===============================
//
//   void setToothDetail(int tooth, String detail) {
//     fdiToothData[tooth] = {"detail": detail};
//     notifyListeners();
//   }
//
//   void setOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void setDentitionType(String value) {
//     dentitionType = value;
//     notifyListeners();
//   }
//
//   void setAgeRange(int? min, int? max) {
//     ageMin = min;
//     ageMax = max;
//     notifyListeners();
//   }
//
//   void setQualityCheck(String signature, DateTime? date) {
//     qualityCheckSignature = signature;
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setMaterialsAvailable({
//     required bool upperWith,
//     required bool lowerWith,
//     required bool upperWithout,
//     required bool lowerWithout,
//     required bool hasFragments,
//     required String teethText,
//     required String otherText,
//   }) {
//     upperJawWithTeeth = upperWith;
//     lowerJawWithTeeth = lowerWith;
//     upperJawWithoutTeeth = upperWithout;
//     lowerJawWithoutTeeth = lowerWithout;
//     fragments = hasFragments;
//     teethOnly = teethText;
//     otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setEachMaterial({
//     bool? upperWith,
//     bool? lowerWith,
//     bool? upperWithout,
//     bool? lowerWithout,
//     bool? hasFragments,
//     String? teethText,
//     String? otherText,
//   }) {
//     if (upperWith != null) upperJawWithTeeth = upperWith;
//     if (lowerWith != null) lowerJawWithTeeth = lowerWith;
//     if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
//     if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
//     if (hasFragments != null) fragments = hasFragments;
//     if (teethText != null) teethOnly = teethText;
//     if (otherText != null) otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setDentalImages({
//     bool? paD, bool? paND,
//     bool? bwD, bool? bwND,
//     bool? opgD, bool? opgND,
//     bool? ctD, bool? ctND,
//     bool? otherD, bool? otherND,
//     bool? photoD, bool? photoND,
//     String? otherRadio,
//     List<String>? uploads,
//   }) {
//     if (paD != null) paDigital = paD;
//     if (paND != null) paNonDigital = paND;
//     if (bwD != null) bwDigital = bwD;
//     if (bwND != null) bwNonDigital = bwND;
//     if (opgD != null) opgDigital = opgD;
//     if (opgND != null) opgNonDigital = opgND;
//     if (ctD != null) ctDigital = ctD;
//     if (ctND != null) ctNonDigital = ctND;
//     if (otherD != null) otherDigital = otherD;
//     if (otherND != null) otherNonDigital = otherND;
//     if (photoD != null) photographsDigital = photoD;
//     if (photoND != null) photographsNonDigital = photoND;
//     if (otherRadio != null) otherRadiographs = otherRadio;
//     if (uploads != null) uploadedFiles = uploads;
//     notifyListeners();
//   }
//
//   void setConditionOfJaws(String value) {
//     conditionOfJaws = value;
//     notifyListeners();
//   }
//
//   void setOtherDetails(String value) {
//     otherDetails = value;
//     notifyListeners();
//   }
//
//   void updateToothDetail(int toothNumber, String detail) {
//     fdiToothData[toothNumber] = {'detail': detail};
//     notifyListeners();
//   }
//
//   void updateOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void updateDentitionType(String type) {
//     dentitionType = type;
//     notifyListeners();
//   }
//
//   void updateAgeMin(int? value) {
//     ageMin = value;
//     notifyListeners();
//   }
//
//   void updateAgeMax(int? value) {
//     ageMax = value;
//     notifyListeners();
//   }
//
//   void updateQualitySignature(String value) {
//     qualityCheckSignature = value;
//     notifyListeners();
//   }
//
//   void updateQualityDate(DateTime date) {
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   // üìå RecordScreen Í¥ÄÎ†® setterÎì§
//   void updatePlace(String place) {
//     placeOfDisaster = place;
//     notifyListeners();
//   }
//
//   void updateNature(String nature) {
//     natureOfDisaster = nature;
//     notifyListeners();
//   }
//
//   void updatePmNumber(String pm) {
//     pmNumber = pm;
//     notifyListeners();
//   }
//
//   void updateDisasterDate(DateTime date) {
//     dateOfDisaster = date;
//     notifyListeners();
//   }
//
//   void updateGender(String selectedGender) {
//     gender = selectedGender;
//     notifyListeners();
//   }
//
//   void setFdiToothData(Map<int, Map<String, String>> newData) {
//     fdiToothData.clear();
//     fdiToothData.addAll(newData);
//     notifyListeners();
//   }
//
//   void resetAll() {
//     // FDI ÏπòÏïÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
//     fdiToothData.clear();
//
//     // Íµ¨Í∞ï Ï†ïÎ≥¥
//     otherFindings = "";
//     dentitionType = "";
//     ageMin = null;
//     ageMax = null;
//     qualityCheckSignature = "";
//     qualityCheckDate = null;
//
//     // Materials Available
//     upperJawWithTeeth = false;
//     lowerJawWithTeeth = false;
//     upperJawWithoutTeeth = false;
//     lowerJawWithoutTeeth = false;
//     fragments = false;
//     teethOnly = '';
//     otherMaterials = '';
//
//     // Radiographs
//     paDigital = false;
//     paNonDigital = false;
//     bwDigital = false;
//     bwNonDigital = false;
//     opgDigital = false;
//     opgNonDigital = false;
//     ctDigital = false;
//     ctNonDigital = false;
//     otherDigital = false;
//     otherNonDigital = false;
//     photographsDigital = false;
//     photographsNonDigital = false;
//     otherRadiographs = '';
//     uploadedFiles = [];
//
//     // ÌÑ± ÏÉÅÌÉú Î∞è Í∏∞ÌÉÄ
//     conditionOfJaws = '';
//     otherDetails = '';
//
//     // RecordScreen Í¥ÄÎ†® ÌïÑÎìú
//     placeOfDisaster = '';
//     natureOfDisaster = '';
//     pmNumber = '';
//     dateOfDisaster = null;
//     gender = '';
//
//     notifyListeners();
//   }
//
//   void addUploadedFile(String fileUrl) {
//     uploadedFiles.add(fileUrl);
//     notifyListeners();
//   }
//
//   void removeUploadedFile(String fileUrl) {
//     uploadedFiles.remove(fileUrl);
//     notifyListeners();
//   }
//
//   // ===============================
//   //         FIREBASE Ï†ÄÏû•Ïö©
//   // ===============================
//
//   Map<String, dynamic> toMap() {
//     return {
//       'placeOfDisaster': placeOfDisaster,
//       'natureOfDisaster': natureOfDisaster,
//       'pmNumber': pmNumber,
//       'dateOfDisaster': dateOfDisaster?.toIso8601String(),
//       'gender': gender,
//
//       'fdiToothData': fdiToothData.map((k, v) => MapEntry(k.toString(), v)),
//       'otherFindings': otherFindings,
//       'dentitionType': dentitionType,
//       'ageMin': ageMin,
//       'ageMax': ageMax,
//       'qualityCheckSignature': qualityCheckSignature,
//       'qualityCheckDate': qualityCheckDate?.toIso8601String(),
//
//       'upperJawWithTeeth': upperJawWithTeeth,
//       'lowerJawWithTeeth': lowerJawWithTeeth,
//       'upperJawWithoutTeeth': upperJawWithoutTeeth,
//       'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
//       'fragments': fragments,
//       'teethOnly': teethOnly,
//       'otherMaterials': otherMaterials,
//
//       'paDigital': paDigital,
//       'paNonDigital': paNonDigital,
//       'bwDigital': bwDigital,
//       'bwNonDigital': bwNonDigital,
//       'opgDigital': opgDigital,
//       'opgNonDigital': opgNonDigital,
//       'ctDigital': ctDigital,
//       'ctNonDigital': ctNonDigital,
//       'otherDigital': otherDigital,
//       'otherNonDigital': otherNonDigital,
//       'photographsDigital': photographsDigital,
//       'photographsNonDigital': photographsNonDigital,
//       'otherRadiographs': otherRadiographs,
//       'uploadedFiles': uploadedFiles,
//
//       'conditionOfJaws': conditionOfJaws,
//       'otherDetails': otherDetails,
//     };
//   }
// }

// import 'package:flutter/material.dart';
// import 'package:shared_preferences/shared_preferences.dart';
//
// class DentalDataProvider extends ChangeNotifier {
//
//   // üìå Í∏∞Î°ù Ïú†Ìòï(PM/AM) + AM Î≤àÌò∏
//   String recordType = 'PM';   // 'PM' ÎòêÎäî 'AM'
//   String amNumber = '';
//
//   // üìå FDI ÏπòÏïÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞
//   final Map<int, Map<String, dynamic>> fdiToothData = {};
//
//   // DentalDataProvider ÏÉùÏÑ±ÏûêÏóê Î°úÎìú Ìò∏Ï∂ú
//   DentalDataProvider() {
//     _loadIncidentPrefs(); // Ïï± ÏãúÏûë Ïãú Ï†ÄÏû•Îêú Ïû†Í∏à ÏÉÅÌÉú/Í∞í Î≥µÍµ¨
//   }
//
// // ÌÇ§ ÏÉÅÏàò
//   static const _kLockEnabledKey = 'incidentLockEnabled';
//   static const _kLockedPlaceKey = 'lockedPlace';
//   static const _kLockedNatureKey = 'lockedNature';
//
// // Ï†ÄÏû•Îêú Í∞í Î∂àÎü¨Ïò§Í∏∞
//   Future<void> _loadIncidentPrefs() async {
//     final prefs = await SharedPreferences.getInstance();
//     incidentLockEnabled = prefs.getBool(_kLockEnabledKey) ?? false;
//     lockedPlace = prefs.getString(_kLockedPlaceKey) ?? '';
//     lockedNature = prefs.getString(_kLockedNatureKey) ?? '';
//     notifyListeners();
//   }
//
// // Ï†ÄÏû•ÌïòÍ∏∞
//   Future<void> _saveIncidentPrefs() async {
//     final prefs = await SharedPreferences.getInstance();
//     await prefs.setBool(_kLockEnabledKey, incidentLockEnabled);
//     await prefs.setString(_kLockedPlaceKey, lockedPlace);
//     await prefs.setString(_kLockedNatureKey, lockedNature);
//   }
//
//   // üìå 640: Í∏∞ÌÉÄ ÏÜåÍ≤¨
//   String otherFindings = "";
//
//   // üìå 645: ÏπòÏó¥ Ïú†Ìòï
//   String dentitionType = "";
//
//   // üìå 647: ÎÇòÏù¥ Ï∂îÏ†ï
//   int? ageMin;
//   int? ageMax;
//
//   // üìå 650: ÌíàÏßà ÌôïÏù∏
//   String qualityCheckSignature = "";
//   DateTime? qualityCheckDate;
//
//   // üìå 610: Materials Available
//   bool upperJawWithTeeth = false;
//   bool lowerJawWithTeeth = false;
//   bool upperJawWithoutTeeth = false;
//   bool lowerJawWithoutTeeth = false;
//   bool fragments = false;
//   String teethOnly = '';
//   String otherMaterials = '';
//
//   bool paDigital = false;
//   bool paNonDigital = false;
//   bool bwDigital = false;
//   bool bwNonDigital = false;
//   bool opgDigital = false;
//   bool opgNonDigital = false;
//   bool ctDigital = false;
//   bool ctNonDigital = false;
//   bool otherDigital = false;
//   bool otherNonDigital = false;
//   bool photographsDigital = false;
//   bool photographsNonDigital = false;
//   String otherRadiographs = '';
//   List<String> uploadedFiles = [];
//
//   String conditionOfJaws = '';
//   String otherDetails = '';
//
//   // üìå RecordScreen Í¥ÄÎ†® ÌïÑÎìú (ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏõêÎ≥∏)
//   String placeOfDisaster = '';
//   String natureOfDisaster = '';
//   String pmNumber = '';
//   DateTime? dateOfDisaster;
//   String gender = '';
//
//   // ===============================
//   //  Incident Lock (Ï¥àÍ∏∞ OFF, Í∞í ÎπÑÏñ¥ÏûàÏùå)
//   // ===============================
//   bool incidentLockEnabled = false;
//   String lockedPlace = '';
//   String lockedNature = '';
//
//   /// UI/Ï†ÄÏû•Ïö©: Ïû†Í∏à+Í≥†Ï†ïÍ∞í Ï°¥Ïû¨ Ïãú Í≥†Ï†ïÍ∞í, ÏïÑÎãàÎ©¥ ÏÇ¨Ïö©Ïûê ÏûÖÎ†•Í∞í
//   String get placeForUi =>
//       (incidentLockEnabled && lockedPlace.isNotEmpty) ? lockedPlace : placeOfDisaster;
//   String get natureForUi =>
//       (incidentLockEnabled && lockedNature.isNotEmpty) ? lockedNature : natureOfDisaster;
//
//   /// Í≥†Ï†ïÍ∞í ÏÑ§Ï†ï
//   void setLockedValues({String? place, String? nature}) {
//     if (place != null) lockedPlace = place;
//     if (nature != null) lockedNature = nature;
//     notifyListeners();
//     _saveIncidentPrefs();
//   }
//
//   void setLockedPlace(String v) {
//     lockedPlace = v;
//     notifyListeners();
//   }
//
//   void setLockedNature(String v) {
//     lockedNature = v;
//     notifyListeners();
//   }
//
//   /// Ïû†Í∏à ON (Í≥†Ï†ïÍ∞íÏù¥ Î™®Îëê ÏûàÏñ¥Ïïº true)
//   bool enableIncidentLock({String? place, String? nature}) {
//     if (place != null) lockedPlace = place;
//     if (nature != null) lockedNature = nature;
//     if (lockedPlace.isEmpty || lockedNature.isEmpty) {
//       return false; // Í∞í ÏóÜÏúºÎ©¥ Ïã§Ìå®
//     }
//     incidentLockEnabled = true;
//     notifyListeners();
//     _saveIncidentPrefs();
//     return true;
//   }
//
//   /// Ïû†Í∏à OFF
//   void disableIncidentLock() {
//     incidentLockEnabled = false;
//     notifyListeners();
//     _saveIncidentPrefs();
//   }
//
//   void updateRecordType(String type) {
//     if (type != 'PM' && type != 'AM') return; // Ïú†Ìö®ÏÑ± Ï≤¥ÌÅ¨
//     if (recordType == type) return;           // ÎèôÏùº Í∞íÏù¥Î©¥ Î¨¥Ïãú
//     recordType = type;
//     notifyListeners();
//   }
//
//   void updateAmNumber(String value) {
//     if (amNumber == value) return;            // ÎèôÏùº Í∞íÏù¥Î©¥ Î¨¥Ïãú
//     amNumber = value;
//     notifyListeners();
//   }
//
//   // ===============================
//   //           SETTERS
//   // ===============================
//   void setToothDetail(int tooth, String detail) {
//     fdiToothData[tooth] = {"detail": detail};
//     notifyListeners();
//   }
//
//   void setOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void setDentitionType(String value) {
//     dentitionType = value;
//     notifyListeners();
//   }
//
//   void setAgeRange(int? min, int? max) {
//     ageMin = min;
//     ageMax = max;
//     notifyListeners();
//   }
//
//   void setQualityCheck(String signature, DateTime? date) {
//     qualityCheckSignature = signature;
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setMaterialsAvailable({
//     required bool upperWith,
//     required bool lowerWith,
//     required bool upperWithout,
//     required bool lowerWithout,
//     required bool hasFragments,
//     required String teethText,
//     required String otherText,
//   }) {
//     upperJawWithTeeth = upperWith;
//     lowerJawWithTeeth = lowerWith;
//     upperJawWithoutTeeth = upperWithout;
//     lowerJawWithoutTeeth = lowerWithout;
//     fragments = hasFragments;
//     teethOnly = teethText;
//     otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setEachMaterial({
//     bool? upperWith,
//     bool? lowerWith,
//     bool? upperWithout,
//     bool? lowerWithout,
//     bool? hasFragments,
//     String? teethText,
//     String? otherText,
//   }) {
//     if (upperWith != null) upperJawWithTeeth = upperWith;
//     if (lowerWith != null) lowerJawWithTeeth = lowerWith;
//     if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
//     if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
//     if (hasFragments != null) fragments = hasFragments;
//     if (teethText != null) teethOnly = teethText;
//     if (otherText != null) otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setDentalImages({
//     bool? paD,
//     bool? paND,
//     bool? bwD,
//     bool? bwND,
//     bool? opgD,
//     bool? opgND,
//     bool? ctD,
//     bool? ctND,
//     bool? otherD,
//     bool? otherND,
//     bool? photoD,
//     bool? photoND,
//     String? otherRadio,
//     List<String>? uploads,
//   }) {
//     if (paD != null) paDigital = paD;
//     if (paND != null) paNonDigital = paND;
//     if (bwD != null) bwDigital = bwD;
//     if (bwND != null) bwNonDigital = bwND;
//     if (opgD != null) opgDigital = opgD;
//     if (opgND != null) opgNonDigital = opgND;
//     if (ctD != null) ctDigital = ctD;
//     if (ctND != null) ctNonDigital = ctND;
//     if (otherD != null) otherDigital = otherD;
//     if (otherND != null) otherNonDigital = otherND;
//     if (photoD != null) photographsDigital = photoD;
//     if (photoND != null) photographsNonDigital = photoND;
//     if (otherRadio != null) otherRadiographs = otherRadio;
//     if (uploads != null) uploadedFiles = uploads;
//     notifyListeners();
//   }
//
//   void setConditionOfJaws(String value) {
//     conditionOfJaws = value;
//     notifyListeners();
//   }
//
//   void setOtherDetails(String value) {
//     otherDetails = value;
//     notifyListeners();
//   }
//
//   void updateToothDetail(int toothNumber, String detail) {
//     fdiToothData[toothNumber] = {'detail': detail};
//     notifyListeners();
//   }
//
//   void updateOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void updateDentitionType(String type) {
//     dentitionType = type;
//     notifyListeners();
//   }
//
//   void updateAgeMin(int? value) {
//     ageMin = value;
//     notifyListeners();
//   }
//
//   void updateAgeMax(int? value) {
//     ageMax = value;
//     notifyListeners();
//   }
//
//   void updateQualitySignature(String value) {
//     qualityCheckSignature = value;
//     notifyListeners();
//   }
//
//   void updateQualityDate(DateTime date) {
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   // üìå RecordScreen Í¥ÄÎ†® setterÎì§
//   void updatePlace(String place) {
//     if (incidentLockEnabled) return; // Ïû†Í∏à Ïãú Î¨¥Ïãú
//     placeOfDisaster = place;
//     notifyListeners();
//   }
//
//   void updateNature(String nature) {
//     if (incidentLockEnabled) return; // Ïû†Í∏à Ïãú Î¨¥Ïãú
//     natureOfDisaster = nature;
//     notifyListeners();
//   }
//
//   void updatePmNumber(String pm) {
//     pmNumber = pm;
//     notifyListeners();
//   }
//
//   void updateDisasterDate(DateTime date) {
//     dateOfDisaster = date;
//     notifyListeners();
//   }
//
//   void updateGender(String selectedGender) {
//     gender = selectedGender;
//     notifyListeners();
//   }
//
//   void setFdiToothData(Map<int, Map<String, String>> newData) {
//     fdiToothData.clear();
//     fdiToothData.addAll(newData);
//     notifyListeners();
//   }
//
//   void resetAll() {
//
//     recordType = 'PM';
//     amNumber = '';
//
//     // FDI ÏπòÏïÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
//     fdiToothData.clear();
//
//     // Íµ¨Í∞ï Ï†ïÎ≥¥
//     otherFindings = "";
//     dentitionType = "";
//     ageMin = null;
//     ageMax = null;
//     qualityCheckSignature = "";
//     qualityCheckDate = null;
//
//     // Materials Available
//     upperJawWithTeeth = false;
//     lowerJawWithTeeth = false;
//     upperJawWithoutTeeth = false;
//     lowerJawWithoutTeeth = false;
//     fragments = false;
//     teethOnly = '';
//     otherMaterials = '';
//
//     // Radiographs
//     paDigital = false;
//     paNonDigital = false;
//     bwDigital = false;
//     bwNonDigital = false;
//     opgDigital = false;
//     opgNonDigital = false;
//     ctDigital = false;
//     ctNonDigital = false;
//     otherDigital = false;
//     otherNonDigital = false;
//     photographsDigital = false;
//     photographsNonDigital = false;
//     otherRadiographs = '';
//     uploadedFiles = [];
//
//     // ÌÑ± ÏÉÅÌÉú Î∞è Í∏∞ÌÉÄ
//     conditionOfJaws = '';
//     otherDetails = '';
//
//     // RecordScreen Í¥ÄÎ†® ÌïÑÎìú
//     placeOfDisaster = '';
//     natureOfDisaster = '';
//     pmNumber = '';
//     dateOfDisaster = null;
//     gender = '';
//
//     // ‚ö† incidentLockEnabled / lockedPlace / lockedNature Îäî Ïú†ÏßÄ
//     notifyListeners();
//   }
//
//   void addUploadedFile(String fileUrl) {
//     uploadedFiles.add(fileUrl);
//     notifyListeners();
//   }
//
//   void removeUploadedFile(String fileUrl) {
//     uploadedFiles.remove(fileUrl);
//     notifyListeners();
//   }
//
//   // ===============================
//   //         FIREBASE Ï†ÄÏû•Ïö©
//   // ===============================
//   Map<String, dynamic> toMap() {
//     return {
//       'recordType': recordType,
//       'amNumber': amNumber,
//
//       // ‚úÖ Ïû†Í∏à Î∞òÏòÅ Í∞íÏúºÎ°ú Ï†ÄÏû•
//       'placeOfDisaster': placeForUi,
//       'natureOfDisaster': natureForUi,
//
//       'pmNumber': pmNumber,
//       'dateOfDisaster': dateOfDisaster?.toIso8601String(),
//       'gender': gender,
//
//       'fdiToothData': fdiToothData.map((k, v) => MapEntry(k.toString(), v)),
//       'otherFindings': otherFindings,
//       'dentitionType': dentitionType,
//       'ageMin': ageMin,
//       'ageMax': ageMax,
//       'qualityCheckSignature': qualityCheckSignature,
//       'qualityCheckDate': qualityCheckDate?.toIso8601String(),
//
//       'upperJawWithTeeth': upperJawWithTeeth,
//       'lowerJawWithTeeth': lowerJawWithTeeth,
//       'upperJawWithoutTeeth': upperJawWithoutTeeth,
//       'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
//       'fragments': fragments,
//       'teethOnly': teethOnly,
//       'otherMaterials': otherMaterials,
//
//       'paDigital': paDigital,
//       'paNonDigital': paNonDigital,
//       'bwDigital': bwDigital,
//       'bwNonDigital': bwNonDigital,
//       'opgDigital': opgDigital,
//       'opgNonDigital': opgNonDigital,
//       'ctDigital': ctDigital,
//       'ctNonDigital': ctNonDigital,
//       'otherDigital': otherDigital,
//       'otherNonDigital': otherNonDigital,
//       'photographsDigital': photographsDigital,
//       'photographsNonDigital': photographsNonDigital,
//       'otherRadiographs': otherRadiographs,
//       'uploadedFiles': uploadedFiles,
//
//       'conditionOfJaws': conditionOfJaws,
//       'otherDetails': otherDetails,
//     };
//   }
// }

// import 'dart:async';
// import 'package:flutter/material.dart';
// import 'package:cloud_firestore/cloud_firestore.dart';
// import 'package:firebase_auth/firebase_auth.dart';
//
// class DentalDataProvider extends ChangeNotifier {
//   // ===============================
//   //  Record type (PM/AM)
//   // ===============================
//   String recordType = 'PM'; // 'PM' or 'AM'
//   String amNumber = '';
//   String pmNumber = '';
//
//   // ===============================
//   //  Incident Lock (ÏõêÍ≤© Firestore Ïó∞Îèô)
//   // ===============================
//   bool incidentLockEnabled = false;
//   String lockedPlace = '';
//   String lockedNature = '';
//
//   /// Ïû†Í∏à Ï†ÅÏö© Ïãú: Í≥†Ï†ïÍ∞í, ÏïÑÎãàÎ©¥ ÏÇ¨Ïö©Ïûê ÏûÖÎ†•Í∞í
//   String get placeForUi =>
//       (incidentLockEnabled && lockedPlace.isNotEmpty) ? lockedPlace : placeOfDisaster;
//   String get natureForUi =>
//       (incidentLockEnabled && lockedNature.isNotEmpty) ? lockedNature : natureOfDisaster;
//
//   // Firestore Î¨∏ÏÑú Íµ¨ÎèÖ
//   final DocumentReference<Map<String, dynamic>> _lockDoc =
//   FirebaseFirestore.instance.collection('config').doc('incidentLock');
//   StreamSubscription<DocumentSnapshot<Map<String, dynamic>>>? _lockSub;
//
//   DentalDataProvider() {
//     _listenIncidentLock(); // Ïï± ÏãúÏûë Ïãú ÏõêÍ≤© Ïû†Í∏à ÏÉÅÌÉúÎ•º Íµ¨ÎèÖ
//   }
//
//   void _listenIncidentLock() {
//     _lockSub = _lockDoc.snapshots().listen((snap) {
//       final d = snap.data();
//       if (d == null) return;
//       incidentLockEnabled = (d['enabled'] ?? false) as bool;
//       lockedPlace = (d['place'] ?? '') as String;
//       lockedNature = (d['nature'] ?? '') as String;
//       notifyListeners();
//     });
//   }
//
//   /// ÏõêÍ≤©Ïóê Ïû†Í∏à/Í≥†Ï†ïÍ∞í Ï†ÄÏû•(Î™®Îì† Í∏∞Í∏∞Ïóê Î∞òÏòÅ)
//   Future<void> setIncidentLockRemote({
//     required bool enabled,
//     required String place,
//     required String nature,
//   }) async {
//     if (enabled && (place.isEmpty || nature.isEmpty)) {
//       throw ArgumentError('Place/Nature required to enable incident lock.');
//     }
//     await _lockDoc.set({
//       'enabled': enabled,
//       'place': place,
//       'nature': nature,
//       'updatedAt': FieldValue.serverTimestamp(),
//       'byUid': FirebaseAuth.instance.currentUser?.uid,
//     }, SetOptions(merge: true));
//   }
//
//   @override
//   void dispose() {
//     _lockSub?.cancel();
//     super.dispose();
//   }
//
//   // ===============================
//   //  FDI ÏπòÏïÑ Îç∞Ïù¥ÌÑ∞ & Í∏∞ÌÉÄ ÌïÑÎìú
//   // ===============================
//   final Map<int, Map<String, dynamic>> fdiToothData = {};
//
//   String otherFindings = "";
//   String dentitionType = "";
//
//   int? ageMin;
//   int? ageMax;
//
//   String qualityCheckSignature = "";
//   DateTime? qualityCheckDate;
//
//   // 610: Materials Available
//   bool upperJawWithTeeth = false;
//   bool lowerJawWithTeeth = false;
//   bool upperJawWithoutTeeth = false;
//   bool lowerJawWithoutTeeth = false;
//   bool fragments = false;
//   String teethOnly = '';
//   String otherMaterials = '';
//
//   bool paDigital = false;
//   bool paNonDigital = false;
//   bool bwDigital = false;
//   bool bwNonDigital = false;
//   bool opgDigital = false;
//   bool opgNonDigital = false;
//   bool ctDigital = false;
//   bool ctNonDigital = false;
//   bool otherDigital = false;
//   bool otherNonDigital = false;
//   bool photographsDigital = false;
//   bool photographsNonDigital = false;
//   String otherRadiographs = '';
//   List<String> uploadedFiles = [];
//
//   String conditionOfJaws = '';
//   String otherDetails = '';
//
//   // RecordScreen Í¥ÄÎ†® ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏõêÎ≥∏
//   String placeOfDisaster = '';
//   String natureOfDisaster = '';
//   DateTime? dateOfDisaster;
//   String gender = '';
//
//   // ===============================
//   //  Setters / Updaters
//   // ===============================
//   void updateRecordType(String type) {
//     if (type != 'PM' && type != 'AM') return;
//     if (recordType == type) return;
//     recordType = type;
//     notifyListeners();
//   }
//
//   void updateAmNumber(String value) {
//     if (amNumber == value) return;
//     amNumber = value;
//     notifyListeners();
//   }
//
//   void updatePmNumber(String pm) {
//     if (pmNumber == pm) return;
//     pmNumber = pm;
//     notifyListeners();
//   }
//
//   void updatePlace(String place) {
//     if (incidentLockEnabled) return; // Ïû†Í∏à Ïãú Î¨¥Ïãú
//     placeOfDisaster = place;
//     notifyListeners();
//   }
//
//   void updateNature(String nature) {
//     if (incidentLockEnabled) return; // Ïû†Í∏à Ïãú Î¨¥Ïãú
//     natureOfDisaster = nature;
//     notifyListeners();
//   }
//
//   void updateDisasterDate(DateTime date) {
//     dateOfDisaster = date;
//     notifyListeners();
//   }
//
//   void updateGender(String selectedGender) {
//     gender = selectedGender;
//     notifyListeners();
//   }
//
//   void updateToothDetail(int toothNumber, String detail) {
//     fdiToothData[toothNumber] = {'detail': detail};
//     notifyListeners();
//   }
//
//   void updateOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void updateDentitionType(String type) {
//     dentitionType = type;
//     notifyListeners();
//   }
//
//   void updateAgeMin(int? value) {
//     ageMin = value;
//     notifyListeners();
//   }
//
//   void updateAgeMax(int? value) {
//     ageMax = value;
//     notifyListeners();
//   }
//
//   void updateQualitySignature(String value) {
//     qualityCheckSignature = value;
//     notifyListeners();
//   }
//
//   void updateQualityDate(DateTime date) {
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setToothDetail(int tooth, String detail) {
//     fdiToothData[tooth] = {"detail": detail};
//     notifyListeners();
//   }
//
//   void setOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void setDentitionType(String value) {
//     dentitionType = value;
//     notifyListeners();
//   }
//
//   void setAgeRange(int? min, int? max) {
//     ageMin = min;
//     ageMax = max;
//     notifyListeners();
//   }
//
//   void setQualityCheck(String signature, DateTime? date) {
//     qualityCheckSignature = signature;
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setMaterialsAvailable({
//     required bool upperWith,
//     required bool lowerWith,
//     required bool upperWithout,
//     required bool lowerWithout,
//     required bool hasFragments,
//     required String teethText,
//     required String otherText,
//   }) {
//     upperJawWithTeeth = upperWith;
//     lowerJawWithTeeth = lowerWith;
//     upperJawWithoutTeeth = upperWithout;
//     lowerJawWithoutTeeth = lowerWithout;
//     fragments = hasFragments;
//     teethOnly = teethText;
//     otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setEachMaterial({
//     bool? upperWith,
//     bool? lowerWith,
//     bool? upperWithout,
//     bool? lowerWithout,
//     bool? hasFragments,
//     String? teethText,
//     String? otherText,
//   }) {
//     if (upperWith != null) upperJawWithTeeth = upperWith;
//     if (lowerWith != null) lowerJawWithTeeth = lowerWith;
//     if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
//     if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
//     if (hasFragments != null) fragments = hasFragments;
//     if (teethText != null) teethOnly = teethText;
//     if (otherText != null) otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setDentalImages({
//     bool? paD,
//     bool? paND,
//     bool? bwD,
//     bool? bwND,
//     bool? opgD,
//     bool? opgND,
//     bool? ctD,
//     bool? ctND,
//     bool? otherD,
//     bool? otherND,
//     bool? photoD,
//     bool? photoND,
//     String? otherRadio,
//     List<String>? uploads,
//   }) {
//     if (paD != null) paDigital = paD;
//     if (paND != null) paNonDigital = paND;
//     if (bwD != null) bwDigital = bwD;
//     if (bwND != null) bwNonDigital = bwND;
//     if (opgD != null) opgDigital = opgD;
//     if (opgND != null) opgNonDigital = opgND;
//     if (ctD != null) ctDigital = ctD;
//     if (ctND != null) ctNonDigital = ctND;
//     if (otherD != null) otherDigital = otherD;
//     if (otherND != null) otherNonDigital = otherND;
//     if (photoD != null) photographsDigital = photoD;
//     if (photoND != null) photographsNonDigital = photoND;
//     if (otherRadio != null) otherRadiographs = otherRadio;
//     if (uploads != null) uploadedFiles = uploads;
//     notifyListeners();
//   }
//
//   void setConditionOfJaws(String value) {
//     conditionOfJaws = value;
//     notifyListeners();
//   }
//
//   void setOtherDetails(String value) {
//     otherDetails = value;
//     notifyListeners();
//   }
//
//   void setFdiToothData(Map<int, Map<String, String>> newData) {
//     fdiToothData.clear();
//     fdiToothData.addAll(newData);
//     notifyListeners();
//   }
//
//   void addUploadedFile(String fileUrl) {
//     uploadedFiles.add(fileUrl);
//     notifyListeners();
//   }
//
//   void removeUploadedFile(String fileUrl) {
//     uploadedFiles.remove(fileUrl);
//     notifyListeners();
//   }
//
//   // ===============================
//   //  Reset / Save
//   // ===============================
//   void resetAll() {
//     recordType = 'PM';
//     amNumber = '';
//     pmNumber = '';
//
//     fdiToothData.clear();
//
//     otherFindings = "";
//     dentitionType = "";
//     ageMin = null;
//     ageMax = null;
//     qualityCheckSignature = "";
//     qualityCheckDate = null;
//
//     upperJawWithTeeth = false;
//     lowerJawWithTeeth = false;
//     upperJawWithoutTeeth = false;
//     lowerJawWithoutTeeth = false;
//     fragments = false;
//     teethOnly = '';
//     otherMaterials = '';
//
//     paDigital = false;
//     paNonDigital = false;
//     bwDigital = false;
//     bwNonDigital = false;
//     opgDigital = false;
//     opgNonDigital = false;
//     ctDigital = false;
//     ctNonDigital = false;
//     otherDigital = false;
//     otherNonDigital = false;
//     photographsDigital = false;
//     photographsNonDigital = false;
//     otherRadiographs = '';
//     uploadedFiles = [];
//
//     conditionOfJaws = '';
//     otherDetails = '';
//
//     placeOfDisaster = '';
//     natureOfDisaster = '';
//     dateOfDisaster = null;
//     gender = '';
//
//     // incidentLockEnabled / lockedPlace / lockedNature Îäî FirestoreÏóêÏÑú Ïú†ÏßÄ/ÎèôÍ∏∞Ìôî
//     notifyListeners();
//   }
//
//   Map<String, dynamic> toMap() {
//     return {
//       'recordType': recordType,
//       'amNumber': amNumber,
//       'pmNumber': pmNumber,
//
//       // Ïû†Í∏à Î∞òÏòÅ Í∞íÏúºÎ°ú Ï†ÄÏû•
//       'placeOfDisaster': placeForUi,
//       'natureOfDisaster': natureForUi,
//
//       'dateOfDisaster': dateOfDisaster?.toIso8601String(),
//       'gender': gender,
//
//       'fdiToothData': fdiToothData.map((k, v) => MapEntry(k.toString(), v)),
//       'otherFindings': otherFindings,
//       'dentitionType': dentitionType,
//       'ageMin': ageMin,
//       'ageMax': ageMax,
//       'qualityCheckSignature': qualityCheckSignature,
//       'qualityCheckDate': qualityCheckDate?.toIso8601String(),
//
//       'upperJawWithTeeth': upperJawWithTeeth,
//       'lowerJawWithTeeth': lowerJawWithTeeth,
//       'upperJawWithoutTeeth': upperJawWithoutTeeth,
//       'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
//       'fragments': fragments,
//       'teethOnly': teethOnly,
//       'otherMaterials': otherMaterials,
//
//       'paDigital': paDigital,
//       'paNonDigital': paNonDigital,
//       'bwDigital': bwDigital,
//       'bwNonDigital': bwNonDigital,
//       'opgDigital': opgDigital,
//       'opgNonDigital': opgNonDigital,
//       'ctDigital': ctDigital,
//       'ctNonDigital': ctNonDigital,
//       'otherDigital': otherDigital,
//       'otherNonDigital': otherNonDigital,
//       'photographsDigital': photographsDigital,
//       'photographsNonDigital': photographsNonDigital,
//       'otherRadiographs': otherRadiographs,
//       'uploadedFiles': uploadedFiles,
//
//       'conditionOfJaws': conditionOfJaws,
//       'otherDetails': otherDetails,
//     };
//   }
// }

// import 'dart:async';
// import 'package:flutter/material.dart';
// import 'package:cloud_firestore/cloud_firestore.dart';
// import 'package:firebase_auth/firebase_auth.dart';
//
// /// 5Î©¥ ÌÇ§ Í≥†Ï†ï (Ï§ëÏïô O, ÏúÑ L, ÏïÑÎûò B, Ï¢å/Ïö∞Îäî M/D)
// const List<String> kToothSurfaces = ['O', 'M', 'D', 'L', 'B'];
//
// /// ÏπòÏãù ÌëúÍ∏∞(635)ÏóêÏÑú ÏÇ¨Ïö©Ìï† ÎßàÌÅ¨ ÌÉÄÏûÖ
// enum ToothMarkType { lesion, restoration, prosthesis, status, other }
//
// /// ÌïòÎÇòÏùò ÏΩîÎìú Ìï≠Î™© (Ïòà: "ABR", "AMF", "UIC" Îì±)
// class ToothMark {
//   final String code;                 // ÌïÑÏàò ÏΩîÎìú Î¨∏ÏûêÏó¥
//   final ToothMarkType type;          // Î∂ÑÎ•ò
//   final bool isParent;               // ÏÉÅÏúÑ Î†àÎ≤®Îßå Ïïå Îïå true (Ïòà: UIC, TCC)
//   final String? note;                // ÏÑ†ÌÉù Î©îÎ™®
//
//   const ToothMark({
//     required this.code,
//     this.type = ToothMarkType.other,
//     this.isParent = false,
//     this.note,
//   });
//
//   Map<String, dynamic> toJson() => {
//     'code': code,
//     'type': type.name,
//     'isParent': isParent,
//     'note': note,
//   };
//
//   factory ToothMark.fromJson(Map<String, dynamic> j) => ToothMark(
//     code: j['code'] as String,
//     type: ToothMarkType.values.firstWhere(
//           (e) => e.name == (j['type'] as String? ?? 'other'),
//       orElse: () => ToothMarkType.other,
//     ),
//     isParent: (j['isParent'] ?? false) as bool,
//     note: j['note'] as String?,
//   );
// }
//
// /// Ìïú ÏπòÏïÑÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞(Ï†ïÍ∑ú Íµ¨Ï°∞)
// class ToothFinding {
//   ToothFinding();
//   /// Î©¥Î≥Ñ ÏΩîÎìú Î™©Î°ù (O/M/D/L/B)
//   final Map<String, List<ToothMark>> surfaces = {
//     for (final s in kToothSurfaces) s: <ToothMark>[],
//   };
//
//   /// ÌôïÎåÄ ÌôîÎ©¥ÏóêÏÑú Îã®Ïàú Ï±ÑÏÉâ/ÏÑ†ÌÉùÎßåÏùÑ ÏúÑÌïú ÌëúÎ©¥ ÌÜ†Í∏Ä ÏÉÅÌÉú
//   final Set<String> selected = <String>{};
//
//   /// ÏπòÏïÑ Ï†ÑÏ≤¥(ÌëúÎ©¥ Î¨¥Í¥Ä) ÏΩîÎìú Î™©Î°ù (Status Îì±)
//   final List<ToothMark> global = <ToothMark>[];
//
//   /// Î©¥Î≥Ñ Î©îÎ™®
//   final Map<String, String> surfaceNote = <String, String>{};
//
//   /// ÏπòÏïÑ Ï†ÑÏ≤¥ Î©îÎ™®
//   String? toothNote;
//
//   Map<String, dynamic> toJson() => {
//     'surfaces': {
//       for (final e in surfaces.entries)
//         e.key: e.value.map((m) => m.toJson()).toList(),
//     },
//     'selected': selected.toList(),
//     'global': global.map((m) => m.toJson()).toList(),
//     'surfaceNote': surfaceNote,
//     'toothNote': toothNote,
//   };
//
//   factory ToothFinding.fromJson(Map<String, dynamic> j) {
//     final tf = ToothFinding();
//     final surf = (j['surfaces'] as Map?) ?? {};
//     for (final s in kToothSurfaces) {
//       final list = (surf[s] as List?) ?? const [];
//       tf.surfaces[s]!.addAll(list.map((e) => ToothMark.fromJson(Map<String, dynamic>.from(e))));
//     }
//     final sel = (j['selected'] as List?) ?? const [];
//     tf.selected.addAll(sel.map((e) => e.toString()));
//     final gl = (j['global'] as List?) ?? const [];
//     tf.global.addAll(gl.map((e) => ToothMark.fromJson(Map<String, dynamic>.from(e))));
//     final sn = (j['surfaceNote'] as Map?) ?? {};
//     tf.surfaceNote.addAll(sn.map((k, v) => MapEntry(k.toString(), v.toString())));
//     tf.toothNote = j['toothNote'] as String?;
//     return tf;
//   }
// }
//
// class DentalDataProvider extends ChangeNotifier {
//   // ----------------- Record / Incident lock -----------------
//   String recordType = 'PM';
//   String amNumber = '';
//   String pmNumber = '';
//
//   bool incidentLockEnabled = false;
//   String lockedPlace = '';
//   String lockedNature = '';
//   String get placeForUi =>
//       (incidentLockEnabled && lockedPlace.isNotEmpty) ? lockedPlace : placeOfDisaster;
//   String get natureForUi =>
//       (incidentLockEnabled && lockedNature.isNotEmpty) ? lockedNature : natureOfDisaster;
//
//   final DocumentReference<Map<String, dynamic>> _lockDoc =
//   FirebaseFirestore.instance.collection('config').doc('incidentLock');
//   StreamSubscription<DocumentSnapshot<Map<String, dynamic>>>? _lockSub;
//
//   DentalDataProvider() {
//     _listenIncidentLock();
//   }
//
//   void _listenIncidentLock() {
//     _lockSub = _lockDoc.snapshots().listen((snap) {
//       final d = snap.data();
//       if (d == null) return;
//       incidentLockEnabled = (d['enabled'] ?? false) as bool;
//       lockedPlace = (d['place'] ?? '') as String;
//       lockedNature = (d['nature'] ?? '') as String;
//       notifyListeners();
//     });
//   }
//
//   Future<void> setIncidentLockRemote({
//     required bool enabled,
//     required String place,
//     required String nature,
//   }) async {
//     if (enabled && (place.isEmpty || nature.isEmpty)) {
//       throw ArgumentError('Place/Nature required to enable incident lock.');
//     }
//     await _lockDoc.set(
//       {
//         'enabled': enabled,
//         'place': place,
//         'nature': nature,
//         'updatedAt': FieldValue.serverTimestamp(),
//         'byUid': FirebaseAuth.instance.currentUser?.uid,
//       },
//       SetOptions(merge: true),
//     );
//   }
//
//   @override
//   void dispose() {
//     _lockSub?.cancel();
//     super.dispose();
//   }
//
//   // ----------------- Odontogram Îç∞Ïù¥ÌÑ∞ -----------------
//
//   /// (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥ Ï†ÄÏû•Ïö© ‚Äì ÏùºÎ∂Ä ÌôîÎ©¥Ïù¥ ÏÇ¨Ïö© Ï§ëÏùº Ïàò ÏûàÏñ¥ Ïú†ÏßÄ
//   final Map<int, Map<String, dynamic>> fdiToothData = <int, Map<String, dynamic>>{};
//
//   /// Ï†ïÍ∑ú Íµ¨Ï°∞
//   final Map<int, ToothFinding> teethFindings = <int, ToothFinding>{};
//
//   ToothFinding _getOrCreate(int fdi) =>
//       teethFindings.putIfAbsent(fdi, () => ToothFinding());
//
//   // ----- 5Î©¥ ÏÑ†ÌÉù(Ï±ÑÏÉâ) API -----
//   Set<String> getSelectedSurfaces(int fdi) {
//     final t = teethFindings[fdi];
//     if (t == null) return {};
//     // ÏÑ†ÌÉù ÌÜ†Í∏Ä + Ïã§Îç∞Ïù¥ÌÑ∞ Ï°¥Ïû¨Î©¥ ÏÑ†ÌÉùÏúºÎ°ú Í∞ÑÏ£º
//     final hasData = kToothSurfaces.where((s) => (t.surfaces[s]!.isNotEmpty) || t.surfaceNote.containsKey(s));
//     return {...t.selected, ...hasData};
//   }
//
//   void toggleSurface(int fdi, String surfaceKey) {
//     if (!kToothSurfaces.contains(surfaceKey)) return;
//     final t = _getOrCreate(fdi);
//     if (t.selected.contains(surfaceKey)) {
//       t.selected.remove(surfaceKey);
//     } else {
//       t.selected.add(surfaceKey);
//     }
//     notifyListeners();
//   }
//
//   void clearSurfaces(int fdi) {
//     final t = _getOrCreate(fdi);
//     t.selected.clear();
//     notifyListeners();
//   }
//
//   // ----- ÏΩîÎìú(635) / Î©îÎ™® -----
//   /// ÌëúÎ©¥Ïóê ÏΩîÎìú Ï∂îÍ∞Ä (surface == null Ïù¥Î©¥ ÏπòÏïÑ Ï†ÑÏó≠)
//   void addMark({
//     required int fdi,
//     String? surface,
//     required ToothMark mark,
//   }) {
//     final t = _getOrCreate(fdi);
//     if (surface == null) {
//       t.global.add(mark);
//     } else {
//       if (!kToothSurfaces.contains(surface)) return;
//       t.surfaces[surface]!.add(mark);
//     }
//     notifyListeners();
//   }
//
//   /// ÌäπÏ†ï ÌëúÎ©¥Ïùò ÏΩîÎìú/Î©îÎ™® Ï†ÑÏ≤¥ ÏÇ≠Ï†ú (ÏÑ†ÌÉù ÌÜ†Í∏ÄÏùÄ Ïú†ÏßÄ)
//   void clearSurfaceData(int fdi, String surface) {
//     final t = _getOrCreate(fdi);
//     if (!kToothSurfaces.contains(surface)) return;
//     t.surfaces[surface]!.clear();
//     t.surfaceNote.remove(surface);
//     notifyListeners();
//   }
//
//   /// ÏπòÏïÑ Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî(ÏÑ†ÌÉù/ÏΩîÎìú/Î©îÎ™® Î™®Îëê)
//   void clearTooth(int fdi) {
//     teethFindings.remove(fdi);
//     fdiToothData.remove(fdi);
//     notifyListeners();
//   }
//
//   void setSurfaceNote(int fdi, String surface, String note) {
//     if (!kToothSurfaces.contains(surface)) return;
//     final t = _getOrCreate(fdi);
//     t.surfaceNote[surface] = note;
//     notifyListeners();
//   }
//
//   void setToothNote(int fdi, String? note) {
//     final t = _getOrCreate(fdi);
//     final n = note?.trim();
//     t.toothNote = (n == null || n.isEmpty) ? null : n;
//     notifyListeners();
//   }
//
//   /// 635 Ï∂úÎ†•Ïö© Î¨∏ÏûêÏó¥ Ìïú Ï§Ñ ÏÉùÏÑ± (Ïòà: "ABR(M) ¬∑ AMF(O) ¬∑ UIC ¬∑ note:‚Ä¶")
//   String build635Line(int fdi) {
//     final t = teethFindings[fdi];
//     if (t == null) return '';
//     final out = <String>[];
//
//     for (final s in kToothSurfaces) {
//       final list = t.surfaces[s]!;
//       if (list.isEmpty) continue;
//       final codes = list.map((m) => m.code).join(',');
//       out.add('$codes($s)');
//     }
//     if (t.global.isNotEmpty) {
//       out.addAll(t.global.map((m) => m.code));
//     }
//     if (t.toothNote != null && t.toothNote!.isNotEmpty) {
//       out.add('note:${t.toothNote}');
//     }
//     return out.join(' ¬∑ ');
//   }
//
//   // ----- (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥ Î©îÎ™® -----
//   void setToothDetail(int tooth, String detail) {
//     fdiToothData[tooth] = {'detail': detail};
//     notifyListeners();
//   }
//
//   void bulkSetToothDetail(Iterable<int> teeth, String detail) {
//     for (final t in teeth) {
//       fdiToothData[t] = {'detail': detail};
//     }
//     notifyListeners();
//   }
//
//   void clearToothDetail(int tooth) {
//     fdiToothData.remove(tooth);
//     notifyListeners();
//   }
//
//   // ----------------- ÎÇòÎ®∏ÏßÄ Ìèº ÌïÑÎìú -----------------
//   String otherFindings = "";
//   String dentitionType = "";
//   int? ageMin;
//   int? ageMax;
//   String qualityCheckSignature = "";
//   DateTime? qualityCheckDate;
//
//   // 610 Materials Available
//   bool upperJawWithTeeth = false;
//   bool lowerJawWithTeeth = false;
//   bool upperJawWithoutTeeth = false;
//   bool lowerJawWithoutTeeth = false;
//   bool fragments = false;
//   String teethOnly = '';
//   String otherMaterials = '';
//
//   // Radiographs
//   bool paDigital = false;
//   bool paNonDigital = false;
//   bool bwDigital = false;
//   bool bwNonDigital = false;
//   bool opgDigital = false;
//   bool opgNonDigital = false;
//   bool ctDigital = false;
//   bool ctNonDigital = false;
//   bool otherDigital = false;
//   bool otherNonDigital = false;
//   bool photographsDigital = false;
//   bool photographsNonDigital = false;
//   String otherRadiographs = '';
//   List<String> uploadedFiles = [];
//
//   String conditionOfJaws = '';
//   String otherDetails = '';
//
//   // RecordScreen ÏõêÎ≥∏ ÏûÖÎ†•
//   String placeOfDisaster = '';
//   String natureOfDisaster = '';
//   DateTime? dateOfDisaster;
//   String gender = '';
//
//   // ----------------- Updaters -----------------
//   void updateRecordType(String type) {
//     if (type != 'PM' && type != 'AM') return;
//     if (recordType == type) return;
//     recordType = type;
//     notifyListeners();
//   }
//
//   void updateAmNumber(String value) {
//     if (amNumber == value) return;
//     amNumber = value;
//     notifyListeners();
//   }
//
//   void updatePmNumber(String pm) {
//     if (pmNumber == pm) return;
//     pmNumber = pm;
//     notifyListeners();
//   }
//
//   void updatePlace(String place) {
//     if (incidentLockEnabled) return;
//     placeOfDisaster = place;
//     notifyListeners();
//   }
//
//   void updateNature(String nature) {
//     if (incidentLockEnabled) return;
//     natureOfDisaster = nature;
//     notifyListeners();
//   }
//
//   void updateDisasterDate(DateTime date) {
//     dateOfDisaster = date;
//     notifyListeners();
//   }
//
//   void updateGender(String selectedGender) {
//     gender = selectedGender;
//     notifyListeners();
//   }
//
//   void updateOtherFindings(String value) {
//     otherFindings = value;
//     notifyListeners();
//   }
//
//   void updateDentitionType(String type) {
//     dentitionType = type;
//     notifyListeners();
//   }
//
//   void updateAgeMin(int? value) {
//     ageMin = value;
//     notifyListeners();
//   }
//
//   void updateAgeMax(int? value) {
//     ageMax = value;
//     notifyListeners();
//   }
//
//   void updateQualitySignature(String value) {
//     qualityCheckSignature = value;
//     notifyListeners();
//   }
//
//   void updateQualityDate(DateTime date) {
//     qualityCheckDate = date;
//     notifyListeners();
//   }
//
//   void setMaterialsAvailable({
//     required bool upperWith,
//     required bool lowerWith,
//     required bool upperWithout,
//     required bool lowerWithout,
//     required bool hasFragments,
//     required String teethText,
//     required String otherText,
//   }) {
//     upperJawWithTeeth = upperWith;
//     lowerJawWithTeeth = lowerWith;
//     upperJawWithoutTeeth = upperWithout;
//     lowerJawWithoutTeeth = lowerWithout;
//     fragments = hasFragments;
//     teethOnly = teethText;
//     otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setEachMaterial({
//     bool? upperWith,
//     bool? lowerWith,
//     bool? upperWithout,
//     bool? lowerWithout,
//     bool? hasFragments,
//     String? teethText,
//     String? otherText,
//   }) {
//     if (upperWith != null) upperJawWithTeeth = upperWith;
//     if (lowerWith != null) lowerJawWithTeeth = lowerWith;
//     if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
//     if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
//     if (hasFragments != null) fragments = hasFragments;
//     if (teethText != null) teethOnly = teethText;
//     if (otherText != null) otherMaterials = otherText;
//     notifyListeners();
//   }
//
//   void setDentalImages({
//     bool? paD,
//     bool? paND,
//     bool? bwD,
//     bool? bwND,
//     bool? opgD,
//     bool? opgND,
//     bool? ctD,
//     bool? ctND,
//     bool? otherD,
//     bool? otherND,
//     bool? photoD,
//     bool? photoND,
//     String? otherRadio,
//     List<String>? uploads,
//   }) {
//     if (paD != null) paDigital = paD;
//     if (paND != null) paNonDigital = paND;
//     if (bwD != null) bwDigital = bwD;
//     if (bwND != null) bwNonDigital = bwND;
//     if (opgD != null) opgDigital = opgD;
//     if (opgND != null) opgNonDigital = opgND;
//     if (ctD != null) ctDigital = ctD;
//     if (ctND != null) ctNonDigital = ctND;
//     if (otherD != null) otherDigital = otherD;
//     if (otherND != null) otherNonDigital = otherND;
//     if (photoD != null) photographsDigital = photoD;
//     if (photoND != null) photographsNonDigital = photoND;
//     if (otherRadio != null) otherRadiographs = otherRadio;
//     if (uploads != null) uploadedFiles = uploads;
//     notifyListeners();
//   }
//
//   void setConditionOfJaws(String value) {
//     conditionOfJaws = value;
//     notifyListeners();
//   }
//
//   void setOtherDetails(String value) {
//     otherDetails = value;
//     notifyListeners();
//   }
//
//   void setFdiToothData(Map<int, Map<String, String>> newData) {
//     fdiToothData.clear();
//     fdiToothData.addAll(newData);
//     notifyListeners();
//   }
//
//   void addUploadedFile(String fileUrl) {
//     uploadedFiles.add(fileUrl);
//     notifyListeners();
//   }
//
//   void removeUploadedFile(String fileUrl) {
//     uploadedFiles.remove(fileUrl);
//     notifyListeners();
//   }
//
//   // ----------------- Reset / Save -----------------
//   void resetAll() {
//     recordType = 'PM';
//     amNumber = '';
//     pmNumber = '';
//
//     fdiToothData.clear();
//     teethFindings.clear();
//
//     otherFindings = "";
//     dentitionType = "";
//     ageMin = null;
//     ageMax = null;
//     qualityCheckSignature = "";
//     qualityCheckDate = null;
//
//     upperJawWithTeeth = false;
//     lowerJawWithTeeth = false;
//     upperJawWithoutTeeth = false;
//     lowerJawWithoutTeeth = false;
//     fragments = false;
//     teethOnly = '';
//     otherMaterials = '';
//
//     paDigital = false;
//     paNonDigital = false;
//     bwDigital = false;
//     bwNonDigital = false;
//     opgDigital = false;
//     opgNonDigital = false;
//     ctDigital = false;
//     ctNonDigital = false;
//     otherDigital = false;
//     otherNonDigital = false;
//     photographsDigital = false;
//     photographsNonDigital = false;
//     otherRadiographs = '';
//     uploadedFiles = [];
//
//     conditionOfJaws = '';
//     otherDetails = '';
//
//     placeOfDisaster = '';
//     natureOfDisaster = '';
//     dateOfDisaster = null;
//     gender = '';
//
//     notifyListeners();
//   }
//
//   Map<String, dynamic> toMap() {
//     return {
//       'recordType': recordType,
//       'amNumber': amNumber,
//       'pmNumber': pmNumber,
//       'placeOfDisaster': placeForUi,
//       'natureOfDisaster': natureForUi,
//       'dateOfDisaster': dateOfDisaster?.toIso8601String(),
//       'gender': gender,
//
//       // Ï†ïÍ∑ú Íµ¨Ï°∞ Ï†ÄÏû•
//       'teethFindings': {
//         for (final e in teethFindings.entries) e.key.toString(): e.value.toJson(),
//       },
//
//       // (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥
//       'fdiToothData': {for (final e in fdiToothData.entries) e.key.toString(): e.value},
//
//       'otherFindings': otherFindings,
//       'dentitionType': dentitionType,
//       'ageMin': ageMin,
//       'ageMax': ageMax,
//       'qualityCheckSignature': qualityCheckSignature,
//       'qualityCheckDate': qualityCheckDate?.toIso8601String(),
//
//       'upperJawWithTeeth': upperJawWithTeeth,
//       'lowerJawWithTeeth': lowerJawWithTeeth,
//       'upperJawWithoutTeeth': upperJawWithoutTeeth,
//       'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
//       'fragments': fragments,
//       'teethOnly': teethOnly,
//       'otherMaterials': otherMaterials,
//
//       'paDigital': paDigital,
//       'paNonDigital': paNonDigital,
//       'bwDigital': bwDigital,
//       'bwNonDigital': bwNonDigital,
//       'opgDigital': opgDigital,
//       'opgNonDigital': opgNonDigital,
//       'ctDigital': ctDigital,
//       'ctNonDigital': ctNonDigital,
//       'otherDigital': otherDigital,
//       'otherNonDigital': otherNonDigital,
//       'photographsDigital': photographsDigital,
//       'photographsNonDigital': photographsNonDigital,
//       'otherRadiographs': otherRadiographs,
//       'uploadedFiles': uploadedFiles,
//
//       'conditionOfJaws': conditionOfJaws,
//       'otherDetails': otherDetails,
//     };
//   }
// }

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';

/// 5Î©¥ ÌÇ§ (Ï§ëÏïô O, ÏúÑ L, ÏïÑÎûò B, Ï¢å/Ïö∞Îäî M/D)
const List<String> kToothSurfaces = ['O', 'M', 'D', 'L', 'B'];

// ===== Ïä§Ìå¨ Î™®Îç∏ =====
enum DentalSpanType { dentureOrtho, bridge }

class DentalSpan {
  final String id;
  final DentalSpanType type;
  final Set<int> teeth;     // Ïù¥ Ïä§Ìå¨Ïóê ÏÜçÌïú Î™®Îì† FDI
  final Set<int> abutments; // bridge Ï†ÑÏö©
  final Set<int> pontics;   // bridge Ï†ÑÏö©
  final String? code;       // denture/ortho ÏΩîÎìú(Ïòà: CLA, FUD ...)

  DentalSpan({
    required this.id,
    required this.type,
    required Set<int> teeth,
    Set<int>? abutments,
    Set<int>? pontics,
    this.code,
  })  : teeth = {...teeth},
        abutments = {...(abutments ?? const <int>{})},
        pontics = {...(pontics ?? const <int>{})};

  Map<String, dynamic> toJson() => {
    'id': id,
    'type': type.name,
    'teeth': teeth.toList(),
    'abutments': abutments.toList(),
    'pontics': pontics.toList(),
    'code': code,
  };

  factory DentalSpan.fromJson(Map<String, dynamic> j) => DentalSpan(
    id: (j['id'] ?? '').toString(),
    type: DentalSpanType.values.firstWhere(
          (e) => e.name == (j['type'] as String? ?? 'dentureOrtho'),
      orElse: () => DentalSpanType.dentureOrtho,
    ),
    teeth: Set<int>.from(
      ((j['teeth'] as List?) ?? const [])
          .map((e) => int.parse(e.toString())),
    ),
    abutments: Set<int>.from(
      ((j['abutments'] as List?) ?? const [])
          .map((e) => int.parse(e.toString())),
    ),
    pontics: Set<int>.from(
      ((j['pontics'] as List?) ?? const [])
          .map((e) => int.parse(e.toString())),
    ),
    code: j['code'] as String?,
  );
}

class DentalDataProvider extends ChangeNotifier {
  // ----------------- Record / Incident lock -----------------
  String recordType = 'PM';
  String amNumber = '';
  String pmNumber = '';

  bool incidentLockEnabled = false;
  String lockedPlace = '';
  String lockedNature = '';
  String get placeForUi =>
      (incidentLockEnabled && lockedPlace.isNotEmpty) ? lockedPlace : placeOfDisaster;
  String get natureForUi =>
      (incidentLockEnabled && lockedNature.isNotEmpty) ? lockedNature : natureOfDisaster;

  final DocumentReference<Map<String, dynamic>> _lockDoc =
  FirebaseFirestore.instance.collection('config').doc('incidentLock');
  StreamSubscription<DocumentSnapshot<Map<String, dynamic>>>? _lockSub;

  DentalDataProvider() {
    _listenIncidentLock();
  }

  void _listenIncidentLock() {
    _lockSub = _lockDoc.snapshots().listen((snap) {
      final d = snap.data();
      if (d == null) return;
      incidentLockEnabled = (d['enabled'] ?? false) as bool;
      lockedPlace = (d['place'] ?? '') as String;
      lockedNature = (d['nature'] ?? '') as String;
      notifyListeners();
    });
  }

  Future<void> setIncidentLockRemote({
    required bool enabled,
    required String place,
    required String nature,
  }) async {
    if (enabled && (place.isEmpty || nature.isEmpty)) {
      throw ArgumentError('Place/Nature required to enable incident lock.');
    }
    await _lockDoc.set(
      {
        'enabled': enabled,
        'place': place,
        'nature': nature,
        'updatedAt': FieldValue.serverTimestamp(),
        'byUid': FirebaseAuth.instance.currentUser?.uid,
      },
      SetOptions(merge: true),
    );
  }

  @override
  void dispose() {
    _lockSub?.cancel();
    super.dispose();
  }

  // ----------------- Odontogram (STEP 2 Ï†ÑÏö© Í≤ΩÎüâ ÏÉÅÌÉú) -----------------

  /// (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥ Î©îÎ™® ‚Äî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
  final Map<int, Map<String, dynamic>> fdiToothData = <int, Map<String, dynamic>>{};

  /// ÌëúÎ©¥ ÏÑ†ÌÉù ÌÜ†Í∏Ä ÏÉÅÌÉúÎßå Í∞ÑÎã® Î≥¥Í¥Ä (STEP 1/2)
  final Map<int, Set<String>> _selectedSurfaces = <int, Set<String>>{};

  Set<String> getSelectedSurfaces(int fdi) => _selectedSurfaces[fdi] ?? <String>{};

  void toggleSurface(int fdi, String surfaceKey) {
    if (!kToothSurfaces.contains(surfaceKey)) return;
    final s = _selectedSurfaces.putIfAbsent(fdi, () => <String>{});
    if (s.contains(surfaceKey)) {
      s.remove(surfaceKey);
    } else {
      s.add(surfaceKey);
    }
    notifyListeners();
  }

  void clearSurfaces(int fdi) {
    final s = _selectedSurfaces[fdi];
    if (s == null) return;
    s.clear();
    notifyListeners();
  }

  // ----------------- STEP 2: Denture/Bridge Ïä§Ìå¨ -----------------
  final List<DentalSpan> spans = <DentalSpan>[];

  String _randId() => DateTime.now().microsecondsSinceEpoch.toString();

  List<DentalSpan> spansIntersecting(Iterable<int> fdis) {
    final set = fdis.toSet();
    return spans.where((sp) => sp.teeth.any(set.contains)).toList();
  }

  void addDentureSpan(List<int> selectedFdi, {String? code}) {
    if (selectedFdi.isEmpty) return;
    spans.add(
      DentalSpan(
        id: _randId(),
        type: DentalSpanType.dentureOrtho,
        teeth: Set<int>.from(selectedFdi),
        code: code,
      ),
    );
    notifyListeners();
  }

  void addBridgeSpan({
    required List<int> selectedFdi,
    required Set<int> abutments,
    required Set<int> pontics,
    String? code,
  }) {
    if (selectedFdi.isEmpty || abutments.isEmpty || pontics.isEmpty) return;
    spans.add(
      DentalSpan(
        id: _randId(),
        type: DentalSpanType.bridge,
        teeth: Set<int>.from(selectedFdi),
        abutments: abutments,
        pontics: pontics,
        code: code,
      ),
    );
    notifyListeners();
  }

  void removeSpan(String id) {
    spans.removeWhere((e) => e.id == id);
    notifyListeners();
  }

  /// ÏÑ†ÌÉùÎêú ÏπòÏïÑÏôÄ ÍµêÏßëÌï©Ïù¥ ÏûàÎäî Ïä§Ìå¨ ÏùºÍ¥Ñ ÏÇ≠Ï†ú (Ìà¥Î∞îÏùò 'Ïä§Ìå¨ ÏÇ≠Ï†ú'ÏóêÏÑú ÏÇ¨Ïö©)
  int removeSpansIntersecting(Set<int> targets,
      {bool removeDenture = true, bool removeBridge = true}) {
    final before = spans.length;
    spans.removeWhere((sp) {
      final hit = sp.teeth.any(targets.contains);
      if (!hit) return false;
      if (sp.type == DentalSpanType.dentureOrtho && !removeDenture) return false;
      if (sp.type == DentalSpanType.bridge && !removeBridge) return false;
      return true;
    });
    final removed = before - spans.length;
    if (removed > 0) notifyListeners();
    return removed;
  }

  // ----------------- (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥ Î©îÎ™® Ï°∞Ïûë -----------------
  void setToothDetail(int tooth, String detail) {
    fdiToothData[tooth] = {'detail': detail};
    notifyListeners();
  }

  void bulkSetToothDetail(Iterable<int> teeth, String detail) {
    for (final t in teeth) {
      fdiToothData[t] = {'detail': detail};
    }
    notifyListeners();
  }

  void clearToothDetail(int tooth) {
    fdiToothData.remove(tooth);
    notifyListeners();
  }

  // ----------------- ÎÇòÎ®∏ÏßÄ Ìèº ÌïÑÎìú -----------------
  String otherFindings = "";
  String dentitionType = "";
  int? ageMin;
  int? ageMax;
  String qualityCheckSignature = "";
  DateTime? qualityCheckDate;

  // 610 Materials Available
  bool upperJawWithTeeth = false;
  bool lowerJawWithTeeth = false;
  bool upperJawWithoutTeeth = false;
  bool lowerJawWithoutTeeth = false;
  bool fragments = false;
  String teethOnly = '';
  String otherMaterials = '';

  // Radiographs
  bool paDigital = false;
  bool paNonDigital = false;
  bool bwDigital = false;
  bool bwNonDigital = false;
  bool opgDigital = false;
  bool opgNonDigital = false;
  bool ctDigital = false;
  bool ctNonDigital = false;
  bool otherDigital = false;
  bool otherNonDigital = false;
  bool photographsDigital = false;
  bool photographsNonDigital = false;
  String otherRadiographs = '';
  List<String> uploadedFiles = [];

  String conditionOfJaws = '';
  String otherDetails = '';

  // RecordScreen ÏõêÎ≥∏ ÏûÖÎ†•
  String placeOfDisaster = '';
  String natureOfDisaster = '';
  DateTime? dateOfDisaster;
  String gender = '';

  // ----------------- Updaters -----------------
  void updateRecordType(String type) {
    if (type != 'PM' && type != 'AM') return;
    if (recordType == type) return;
    recordType = type;
    notifyListeners();
  }

  void updateAmNumber(String value) {
    if (amNumber == value) return;
    amNumber = value;
    notifyListeners();
  }

  void updatePmNumber(String pm) {
    if (pmNumber == pm) return;
    pmNumber = pm;
    notifyListeners();
  }

  void updatePlace(String place) {
    if (incidentLockEnabled) return;
    placeOfDisaster = place;
    notifyListeners();
  }

  void updateNature(String nature) {
    if (incidentLockEnabled) return;
    natureOfDisaster = nature;
    notifyListeners();
  }

  void updateDisasterDate(DateTime date) {
    dateOfDisaster = date;
    notifyListeners();
  }

  void updateGender(String selectedGender) {
    gender = selectedGender;
    notifyListeners();
  }

  void updateOtherFindings(String value) {
    otherFindings = value;
    notifyListeners();
  }

  void updateDentitionType(String type) {
    dentitionType = type;
    notifyListeners();
  }

  void updateAgeMin(int? value) {
    ageMin = value;
    notifyListeners();
  }

  void updateAgeMax(int? value) {
    ageMax = value;
    notifyListeners();
  }

  void updateQualitySignature(String value) {
    qualityCheckSignature = value;
    notifyListeners();
  }

  void updateQualityDate(DateTime date) {
    qualityCheckDate = date;
    notifyListeners();
  }

  void setMaterialsAvailable({
    required bool upperWith,
    required bool lowerWith,
    required bool upperWithout,
    required bool lowerWithout,
    required bool hasFragments,
    required String teethText,
    required String otherText,
  }) {
    upperJawWithTeeth = upperWith;
    lowerJawWithTeeth = lowerWith;
    upperJawWithoutTeeth = upperWithout;
    lowerJawWithoutTeeth = lowerWithout;
    fragments = hasFragments;
    teethOnly = teethText;
    otherMaterials = otherText;
    notifyListeners();
  }

  void setEachMaterial({
    bool? upperWith,
    bool? lowerWith,
    bool? upperWithout,
    bool? lowerWithout,
    bool? hasFragments,
    String? teethText,
    String? otherText,
  }) {
    if (upperWith != null) upperJawWithTeeth = upperWith;
    if (lowerWith != null) lowerJawWithTeeth = lowerWith;
    if (upperWithout != null) upperJawWithoutTeeth = upperWithout;
    if (lowerWithout != null) lowerJawWithoutTeeth = lowerWithout;
    if (hasFragments != null) fragments = hasFragments;
    if (teethText != null) teethOnly = teethText;
    if (otherText != null) otherMaterials = otherText;
    notifyListeners();
  }

  void setDentalImages({
    bool? paD,
    bool? paND,
    bool? bwD,
    bool? bwND,
    bool? opgD,
    bool? opgND,
    bool? ctD,
    bool? ctND,
    bool? otherD,
    bool? otherND,
    bool? photoD,
    bool? photoND,
    String? otherRadio,
    List<String>? uploads,
  }) {
    if (paD != null) paDigital = paD;
    if (paND != null) paNonDigital = paND;
    if (bwD != null) bwDigital = bwD;
    if (bwND != null) bwNonDigital = bwND;
    if (opgD != null) opgDigital = opgD;
    if (opgND != null) opgNonDigital = opgND;
    if (ctD != null) ctDigital = ctD;
    if (ctND != null) ctNonDigital = ctND;
    if (otherD != null) otherDigital = otherD;
    if (otherND != null) otherNonDigital = otherND;
    if (photoD != null) photographsDigital = photoD;
    if (photoND != null) photographsNonDigital = photoND;
    if (otherRadio != null) otherRadiographs = otherRadio;
    if (uploads != null) uploadedFiles = uploads;
    notifyListeners();
  }

  void setConditionOfJaws(String value) {
    conditionOfJaws = value;
    notifyListeners();
  }

  void setOtherDetails(String value) {
    otherDetails = value;
    notifyListeners();
  }

  void setFdiToothData(Map<int, Map<String, String>> newData) {
    fdiToothData.clear();
    fdiToothData.addAll(newData);
    notifyListeners();
  }

  void addUploadedFile(String fileUrl) {
    uploadedFiles.add(fileUrl);
    notifyListeners();
  }

  void removeUploadedFile(String fileUrl) {
    uploadedFiles.remove(fileUrl);
    notifyListeners();
  }

  // ----------------- Reset / Save -----------------
  void resetAll() {
    recordType = 'PM';
    amNumber = '';
    pmNumber = '';

    fdiToothData.clear();
    _selectedSurfaces.clear();
    spans.clear();

    otherFindings = "";
    dentitionType = "";
    ageMin = null;
    ageMax = null;
    qualityCheckSignature = "";
    qualityCheckDate = null;

    upperJawWithTeeth = false;
    lowerJawWithTeeth = false;
    upperJawWithoutTeeth = false;
    lowerJawWithoutTeeth = false;
    fragments = false;
    teethOnly = '';
    otherMaterials = '';

    paDigital = false;
    paNonDigital = false;
    bwDigital = false;
    bwNonDigital = false;
    opgDigital = false;
    opgNonDigital = false;
    ctDigital = false;
    ctNonDigital = false;
    otherDigital = false;
    otherNonDigital = false;
    photographsDigital = false;
    photographsNonDigital = false;
    otherRadiographs = '';
    uploadedFiles = [];

    conditionOfJaws = '';
    otherDetails = '';

    placeOfDisaster = '';
    natureOfDisaster = '';
    dateOfDisaster = null;
    gender = '';

    notifyListeners();
  }

  Map<String, dynamic> toMap() {
    return {
      'recordType': recordType,
      'amNumber': amNumber,
      'pmNumber': pmNumber,
      'placeOfDisaster': placeForUi,
      'natureOfDisaster': natureForUi,
      'dateOfDisaster': dateOfDisaster?.toIso8601String(),
      'gender': gender,

      // (ÌïòÏúÑ Ìò∏Ìôò) Í∞ÑÎã® Î¨∏ÏûêÏó¥
      'fdiToothData': {
        for (final e in fdiToothData.entries) e.key.toString(): e.value
      },

      // STEP 2: Ïä§Ìå¨ ÏßÅÎ†¨Ìôî
      'spans': spans.map((e) => e.toJson()).toList(),

      'otherFindings': otherFindings,
      'dentitionType': dentitionType,
      'ageMin': ageMin,
      'ageMax': ageMax,
      'qualityCheckSignature': qualityCheckSignature,
      'qualityCheckDate': qualityCheckDate?.toIso8601String(),

      'upperJawWithTeeth': upperJawWithTeeth,
      'lowerJawWithTeeth': lowerJawWithTeeth,
      'upperJawWithoutTeeth': upperJawWithoutTeeth,
      'lowerJawWithoutTeeth': lowerJawWithoutTeeth,
      'fragments': fragments,
      'teethOnly': teethOnly,
      'otherMaterials': otherMaterials,

      'paDigital': paDigital,
      'paNonDigital': paNonDigital,
      'bwDigital': bwDigital,
      'bwNonDigital': bwNonDigital,
      'opgDigital': opgDigital,
      'opgNonDigital': opgNonDigital,
      'ctDigital': ctDigital,
      'ctNonDigital': ctNonDigital,
      'otherDigital': otherDigital,
      'otherNonDigital': otherNonDigital,
      'photographsDigital': photographsDigital,
      'photographsNonDigital': photographsNonDigital,
      'otherRadiographs': otherRadiographs,
      'uploadedFiles': uploadedFiles,

      'conditionOfJaws': conditionOfJaws,
      'otherDetails': otherDetails,
    };
  }
}




